<!DOCTYPE html>
<html lang="tj">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="pageTitle">Панель Оператора</title>
    <link rel="icon" href="https://i.ibb.co/99sHbMML/logo-operator.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            transition: background-color 0.3s, color 0.3s;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #34d399;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-align: center;
        }
        .status-new { background-color: #3b82f6; color: white; }
        .status-processing { background-color: #f59e0b; color: white; }
        .status-success { background-color: #10b981; color: white; }
        .status-fail { background-color: #ef4444; color: white; }
        .status-forwarded { background-color: #a855f7; color: white; }

        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        #sidebar a.active { background-color: #374151; color: #34d399; }
        #sidebar a.active .badge { background-color: #34d399; color: #111827; }
        
        table { border-collapse: separate; border-spacing: 0 0.5rem; }
        th { text-align: left; padding: 0.75rem 1.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; }
        td { background-color: #1f2937; padding: 1rem 1.5rem; vertical-align: middle; transition: background-color 0.3s; }
        tr td:first-child { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        tr td:last-child { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        
        /* Light Theme */
        body.light-theme { background-color: #f3f4f6; color: #1f2937; }
        .light-theme #sidebar { background-color: #ffffff; }
        .light-theme #sidebar a.active { background-color: #e5e7eb; }
        .light-theme #sidebar a:not(.active) { color: #374151; }
        .light-theme #sidebar h1, .light-theme #sidebar .fa-user-shield { color: #1f2937; }
        .light-theme #db-status { color: #6b7280; }
        .light-theme #main-title, .light-theme h3 { color: #111827; }
        .light-theme td { background-color: #ffffff; }
        .light-theme th { color: #6b7280; }
        .light-theme #edit-modal-content { background-color: #ffffff; border-color: #e5e7eb; }
        .light-theme select, .light-theme textarea, .light-theme #search-input { background-color: #f3f4f6; border-color: #d1d5db; color: #1f2937; }
        .light-theme #comments-history { background-color: #e5e7eb; }
        .light-theme .text-gray-300 { color: #4b5563; }
        .light-theme .text-gray-400 { color: #6b7280; }
        .light-theme .text-gray-500 { color: #6b7280; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-gray-900 p-5 flex-shrink-0 flex flex-col transition-colors">
        <div class="flex items-center space-x-3 mb-4">
            <i class="fas fa-user-shield text-3xl text-emerald-400"></i>
            <h1 class="text-xl font-bold text-white" data-translate-key="panelTitle"></h1>
        </div>
        <div id="operator-info" class="mb-8 text-xs space-y-1 text-gray-400 border-l-2 border-gray-700 pl-3">
            <!-- Operator info will be loaded here -->
        </div>
        <nav id="status-nav" class="flex-1 space-y-2">
            <!-- Links will be generated by JS -->
        </nav>
        <div class="mt-auto space-y-4">
            <div class="flex items-center justify-between">
                <div class="lang-switcher flex items-center bg-gray-800 rounded-md">
                   <button data-lang="ru" class="px-3 py-1 text-sm font-semibold transition-colors rounded-l-md">RU</button>
                   <button data-lang="en" class="px-3 py-1 text-sm font-semibold transition-colors">EN</button>
                   <button data-lang="tj" class="px-3 py-1 text-sm font-semibold transition-colors rounded-r-md">TJ</button>
                </div>
                <button id="theme-switcher" class="p-2 rounded-md bg-gray-800">
                    <svg id="theme-icon-sun" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-moon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
            <p class="text-sm text-gray-500"><span data-translate-key="dbStatusLabel"></span> <span id="db-status" class="font-semibold text-red-500">...</span></p>
            <button id="logout-btn" class="w-full text-left text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i><span data-translate-key="logoutBtn"></span></button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                <h2 id="main-title" class="text-2xl font-bold text-white"></h2>
                <div class="relative w-full md:w-72">
                    <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                </div>
            </div>
            
            <div id="loader" class="loader mx-auto mt-16"></div>
            <div id="no-applications" class="text-center py-16 text-gray-500 hidden">
                <i class="fas fa-folder-open text-5xl mb-4"></i>
                <p id="no-applications-text" class="text-xl"></p>
            </div>
            <div class="w-full overflow-x-auto">
                <table id="applications-table" class="w-full min-w-[1200px]">
                    <thead>
                        <tr id="table-header"></tr>
                    </thead>
                    <tbody id="applications-tbody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Edit Status Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 z-30 flex items-center justify-center p-4 hidden opacity-0 modal">
        <div id="edit-modal-content" class="bg-gray-800 border border-gray-700 rounded-lg p-6 w-full max-w-lg space-y-4 transform scale-95 modal-content">
            <h3 class="text-xl font-bold text-white" data-translate-key="modalTitle"></h3>
            <div class="flex justify-between items-center text-sm text-gray-400">
                <p>ID: <span id="modal-doc-id" class="font-mono"></span></p>
                <p><span data-translate-key="phoneLabel"></span> <span id="modal-phone" class="font-mono"></span></p>
            </div>
            
            <div class="max-h-40 overflow-y-auto bg-gray-900 p-3 rounded-md space-y-3">
                <h4 class="text-sm font-semibold text-gray-300 mb-2" data-translate-key="commentsHistoryLabel"></h4>
                <div id="comments-history"></div>
            </div>

            <div>
                <label for="status-select" class="block text-sm font-medium text-gray-300 mb-2" data-translate-key="newStatusLabel"></label>
                <select id="status-select" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500"></select>
            </div>

            <div>
                <label for="comment-input" class="block text-sm font-medium text-gray-300 mb-2" data-translate-key="newCommentLabel"></label>
                <textarea id="comment-input" rows="3" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500"></textarea>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button id="cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold" data-translate-key="cancelBtn"></button>
                <button id="save-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-md font-semibold text-white" data-translate-key="saveBtn"></button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALN7HBZkSipzmU4nZ5wao-vCzZh5PFdjI",
            authDomain: "baza-dannikh.firebaseapp.com",
            projectId: "baza-dannikh",
            storageBucket: "baza-dannikh.appspot.com",
            messagingSenderId: "227867059344",
            appId: "1:227867059344:web:5afaa96d42f24ebdbce415",
            measurementId: "G-MLE0HCZG8Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Auth Guard ---
        onAuthStateChanged(auth, user => {
            if (!user) {
                localStorage.removeItem('operatorInfo');
                window.location.href = './login.html';
            }
        });

        // --- State ---
        let allApplications = [];
        let currentFilter = 'Все';
        let currentSearchTerm = '';
        let currentEditingDocId = null;
        let currentLang = 'tj';
        let operatorInfo = {};

        // --- Translations ---
        const translations = {
            ru: {
                pageTitle: "Панель Оператора", panelTitle: "Панель Оператора", operatorLabel: "Оператор:", regionLabel: "Регион:", operatorIdLabel: "ID:", dbStatusLabel: "Статус БД:", dbConnecting: "Подключение...", dbOnline: "Онлайн", dbError: "Ошибка", mainTitle: "Все заявки", searchInputPlaceholder: "Поиск по ID или телефону...", noApps: "Новых заявок пока нет", noAppsWithStatus: "Заявок со статусом \"{status}\" нет", noAppsFound: "Заявок не найдено", modalTitle: "Изменить статус заявки", phoneLabel: "Телефон:", commentsHistoryLabel: "История комментариев", newStatusLabel: "Новый статус", newCommentLabel: "Новый комментарий (обязательно)", newCommentPlaceholder: "Причина изменения статуса...", cancelBtn: "Отмена", saveBtn: "Сохранить", savingBtn: "Сохранение...", editBtn: "Изменить", noComments: "Комментариев пока нет.", commentRequired: "Комментарий не может быть пустым.", updateError: "Не удалось обновить статус.", logoutBtn: "Выйти",
                table: { docId: "Номер документа", type: "Тип", fio: "ФИО", phone: "Телефон", date: "Дата подачи", status: "Статус", lastComment: "Последний комментарий", actions: "Действия" },
                statuses: { "Все": "Все заявки", "Новая": "Новые", "В обработке": "В обработке", "Успешна": "Успешные", "Неуспешна": "Неуспешные", "Передана": "Переданные" },
                appTypes: { "internal": "Внутренний паспорт", "foreign": "Загранпаспорт", "drivers_license": "Вод. удостоверение" }
            },
            en: {
                pageTitle: "Operator Dashboard", panelTitle: "Operator Dashboard", operatorLabel: "Operator:", regionLabel: "Region:", operatorIdLabel: "ID:", dbStatusLabel: "DB Status:", dbConnecting: "Connecting...", dbOnline: "Online", dbError: "Error", mainTitle: "All Applications", searchInputPlaceholder: "Search by ID or phone...", noApps: "No new applications yet", noAppsWithStatus: "No applications with status \"{status}\"", noAppsFound: "No applications found", modalTitle: "Change Application Status", phoneLabel: "Phone:", commentsHistoryLabel: "Comments History", newStatusLabel: "New Status", newCommentLabel: "New Comment (required)", newCommentPlaceholder: "Reason for status change...", cancelBtn: "Cancel", saveBtn: "Save", savingBtn: "Saving...", editBtn: "Edit", noComments: "No comments yet.", commentRequired: "Comment cannot be empty.", updateError: "Failed to update status.", logoutBtn: "Logout",
                table: { docId: "Document ID", type: "Type", fio: "Full Name", phone: "Phone", date: "Submission Date", status: "Status", lastComment: "Last Comment", actions: "Actions" },
                statuses: { "Все": "All Applications", "Новая": "New", "В обработке": "In Progress", "Успешна": "Successful", "Неуспешна": "Failed", "Передана": "Forwarded" },
                appTypes: { "internal": "Internal Passport", "foreign": "Foreign Passport", "drivers_license": "Driver's License" }
            },
            tj: {
                pageTitle: "Панели Оператор", panelTitle: "Панели Оператор", operatorLabel: "Оператор:", regionLabel: "Минтақа:", operatorIdLabel: "ID:", dbStatusLabel: "Ҳолати БД:", dbConnecting: "Пайвастшавӣ...", dbOnline: "Онлайн", dbError: "Хатогӣ", mainTitle: "Ҳамаи дархостҳо", searchInputPlaceholder: "Ҷустуҷӯ аз рӯи ID ё телефон...", noApps: "Ҳоло дархостҳои нав вуҷуд надоранд", noAppsWithStatus: "Дархостҳо бо ҳолати \"{status}\" вуҷуд надоранд", noAppsFound: "Дархостҳо ёфт нашуданд", modalTitle: "Тағйир додани ҳолати дархост", phoneLabel: "Телефон:", commentsHistoryLabel: "Таърихи шарҳҳо", newStatusLabel: "Ҳолати нав", newCommentLabel: "Шарҳи нав (ҳатмӣ)", newCommentPlaceholder: "Сабаби тағир додани ҳолат...", cancelBtn: "Бекор кардан", saveBtn: "Захира кардан", savingBtn: "Захиракунӣ...", editBtn: "Тағйир додан", noComments: "Ҳоло шарҳҳо вуҷуд надоранд.", commentRequired: "Шарҳ наметавонад холӣ бошад.", updateError: "Ҳолатро навсозӣ карда натавонист.", logoutBtn: "Баромадан",
                 table: { docId: "Рақами ҳуҷҷат", type: "Намуд", fio: "ННН", phone: "Телефон", date: "Санаи пешниҳод", status: "Ҳолат", lastComment: "Шарҳи охирин", actions: "Амалҳо" },
                statuses: { "Все": "Ҳамаи дархостҳо", "Новая": "Нав", "В обработке": "Дар ҷараён", "Успешна": "Бомуваффақият", "Неуспешна": "Номуваффақ", "Передана": "Интиқол дода шуд" },
                appTypes: { "internal": "Шиносномаи дохилӣ", "foreign": "Шиносномаи хориҷӣ", "drivers_license": "Шаҳодатномаи ронандагӣ" }
            }
        };

        // --- DOM Elements ---
        const applicationsTbody = document.getElementById('applications-tbody');
        const applicationsTable = document.getElementById('applications-table');
        const loader = document.getElementById('loader');
        const noApplicationsMessage = document.getElementById('no-applications');
        const noApplicationsText = document.getElementById('no-applications-text');
        const dbStatus = document.getElementById('db-status');
        const sidebar = document.getElementById('sidebar');
        const mainTitle = document.getElementById('main-title');
        const searchInput = document.getElementById('search-input');
        const statusNav = document.getElementById('status-nav');
        const tableHeader = document.getElementById('table-header');
        const operatorInfoDiv = document.getElementById('operator-info');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Modal Elements
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const modalDocId = document.getElementById('modal-doc-id');
        const modalPhone = document.getElementById('modal-phone');
        const statusSelect = document.getElementById('status-select');
        const commentInput = document.getElementById('comment-input');
        const commentsHistory = document.getElementById('comments-history');
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            localStorage.setItem('language', lang);

            const langPack = translations[lang] || translations['tj'];

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (langPack[key]) {
                    element.innerHTML = langPack[key];
                }
            });
            
            searchInput.placeholder = langPack.searchInputPlaceholder;
            commentInput.placeholder = langPack.newCommentPlaceholder;
            
            document.querySelectorAll('.lang-switcher button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-switcher button[data-lang="${lang}"]`).classList.add('active');

            renderSidebarNav(langPack);
            renderTableHeader(langPack);
            renderOperatorInfo(langPack);
            renderFilteredApplications();
        }

        function renderOperatorInfo(langPack) {
            operatorInfoDiv.innerHTML = `
                <p><strong data-translate-key="operatorLabel">${langPack.operatorLabel}</strong> <span class="text-gray-200">${operatorInfo.name || ''}</span></p>
                <p><strong data-translate-key="regionLabel">${langPack.regionLabel}</strong> <span class="text-gray-200">${operatorInfo.region || ''}</span></p>
                <p><strong data-translate-key="operatorIdLabel">${langPack.operatorIdLabel}</strong> <span class="font-mono text-gray-200">${operatorInfo.operatorId || ''}</span></p>
            `;
        }

        function renderSidebarNav(langPack) {
            statusNav.innerHTML = '';
            Object.keys(langPack.statuses).forEach(statusKey => {
                const link = document.createElement('a');
                link.href = '#';
                link.dataset.status = statusKey;
                link.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-800 transition-colors';
                if(statusKey === currentFilter) link.classList.add('active');
                
                const statusName = langPack.statuses[statusKey];
                const badgeClass = statusKey === 'Все' ? 'bg-gray-700' : getStatusClass(statusKey).replace('status-', 'bg-') + '-500';

                link.innerHTML = `
                    <span class="font-semibold">${statusName}</span>
                    <span id="count-${statusKey}" class="badge ${badgeClass} text-xs font-bold px-2 py-1 rounded-full">0</span>
                `;
                statusNav.appendChild(link);
            });
        }

        function renderTableHeader(langPack) {
            const headers = langPack.table;
            tableHeader.innerHTML = `
                <th>${headers.docId}</th>
                <th>${headers.type}</th>
                <th>${headers.fio}</th>
                <th>${headers.phone}</th>
                <th>${headers.date}</th>
                <th>${headers.status}</th>
                <th>${headers.lastComment}</th>
                <th>${headers.actions}</th>
            `;
        }
        
        const q = query(collection(db, "applications"), orderBy("submittedAt", "desc"));

        onSnapshot(q, (querySnapshot) => {
            loader.classList.add('hidden');
            dbStatus.textContent = translations[currentLang].dbOnline;
            dbStatus.classList.remove('text-red-500');
            dbStatus.classList.add('text-green-400');
            
            allApplications = [];
            querySnapshot.forEach(doc => {
                allApplications.push({ firestoreId: doc.id, ...doc.data() });
            });
            
            updateCounts();
            renderFilteredApplications();

        }, (error) => {
            console.error("Error fetching applications: ", error);
            loader.classList.add('hidden');
            dbStatus.textContent = translations[currentLang].dbError;
            noApplicationsText.textContent = 'Не удалось загрузить данные.';
            noApplicationsMessage.classList.remove('hidden');
        });

        function updateCounts() {
            const counts = {
                'Все': allApplications.length,
                'Новая': 0,
                'В обработке': 0,
                'Успешна': 0,
                'Неуспешна': 0,
                'Передана': 0
            };
            allApplications.forEach(app => {
                if (counts[app.status] !== undefined) {
                    counts[app.status]++;
                }
            });
            for (const status in counts) {
                const countEl = document.getElementById(`count-${status}`);
                if(countEl) countEl.textContent = counts[status];
            }
        }

        function renderFilteredApplications() {
            applicationsTbody.innerHTML = '';
            
            let filteredApps = allApplications;

            if (currentFilter !== 'Все') {
                filteredApps = filteredApps.filter(app => app.status === currentFilter);
            }

            if (currentSearchTerm) {
                const lowerCaseSearch = currentSearchTerm.toLowerCase();
                filteredApps = filteredApps.filter(app => {
                    const phone = app.formData.phone || app.formData.foreignPhone || '';
                    return (app.documentId && app.documentId.toLowerCase().includes(lowerCaseSearch)) ||
                           (phone && phone.includes(lowerCaseSearch));
                });
            }

            const showTable = filteredApps.length > 0;
            applicationsTable.classList.toggle('hidden', !showTable);
            noApplicationsMessage.classList.toggle('hidden', showTable);
            noApplicationsText.textContent = filteredApps.length === 0 && currentSearchTerm ? 
                translations[currentLang].noAppsFound : 
                translations[currentLang].noAppsWithStatus.replace('{status}', translations[currentLang].statuses[currentFilter]);

            filteredApps.forEach(app => {
                applicationsTbody.appendChild(createApplicationRow(app.firestoreId, app));
            });
        }

        function getStatusClass(status) {
            switch (status) {
                case 'В обработке': return 'status-processing';
                case 'Успешна': return 'status-success';
                case 'Неуспешна': return 'status-fail';
                case 'Передана': return 'status-forwarded';
                default: return 'status-new';
            }
        }

        function createApplicationRow(docId, data) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-800 transition-colors';

            const { formData = {}, type = 'Неизвестно', submittedAt, documentId, status = 'Новая', comments = [] } = data;
            const submittedDate = submittedAt ? new Date(submittedAt).toLocaleDateString('ru-RU') : 'N/A';
            const lastComment = comments.length > 0 ? comments[comments.length - 1].text : translations[currentLang].noComments;
            
            const langPack = translations[currentLang];
            let title = langPack.appTypes[type] || type;
            let fullName = formData.fullName || formData.foreignFullName || 'N/A';
            let phone = formData.phone || formData.foreignPhone || 'N/A';

            row.innerHTML = `
                <td><span class="font-mono text-sm">${documentId || 'Нет ID'}</span></td>
                <td>${title}</td>
                <td>${fullName}</td>
                <td>${phone}</td>
                <td>${submittedDate}</td>
                <td><span class="status-badge ${getStatusClass(status)}">${langPack.statuses[status] || status}</span></td>
                <td class="text-gray-400 text-sm max-w-xs truncate">${lastComment}</td>
                <td><button data-doc-id="${docId}" class="edit-btn text-emerald-400 hover:text-emerald-300 font-semibold">${langPack.editBtn}</button></td>
            `;
            return row;
        }

        function openEditModal(docId) {
            currentEditingDocId = docId;
            const appData = allApplications.find(app => app.firestoreId === docId);
            if (!appData) return;

            modalDocId.textContent = docId;
            modalPhone.textContent = appData.formData.phone || appData.formData.foreignPhone || 'N/A';
            
            const langPack = translations[currentLang];
            statusSelect.innerHTML = '';
            Object.keys(langPack.statuses).forEach(statusKey => {
                if(statusKey !== 'Все') {
                    const option = document.createElement('option');
                    option.value = statusKey;
                    option.textContent = langPack.statuses[statusKey];
                    statusSelect.appendChild(option);
                }
            });
            statusSelect.value = appData.status || 'Новая';
            
            commentsHistory.innerHTML = '';
            if (appData.comments && appData.comments.length > 0) {
                 [...appData.comments].reverse().forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'text-xs p-2 bg-gray-700/50 rounded';
                    const commentDate = new Date(comment.timestamp).toLocaleString('ru-RU', { timeZone: 'Asia/Dushanbe' });
                    commentEl.innerHTML = `
                        <p class="font-semibold text-gray-200">${langPack.statuses[comment.status] || comment.status} <span class="text-gray-400 font-normal">- ${comment.operatorId || comment.operatorName}</span></p>
                        <p class="text-gray-400">${comment.text}</p>
                        <p class="text-gray-500 text-right">${commentDate}</p>
                    `;
                    commentsHistory.appendChild(commentEl);
                });
            } else {
                commentsHistory.innerHTML = `<p class="text-xs text-gray-500">${langPack.noComments}</p>`;
            }


            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModal.classList.remove('opacity-0');
                editModalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeEditModal() {
            editModal.classList.add('opacity-0');
            editModalContent.classList.add('scale-95');
            setTimeout(() => {
                editModal.classList.add('hidden');
                currentEditingDocId = null;
                commentInput.value = '';
            }, 300);
        }

        async function saveStatus() {
            if (!currentEditingDocId || !commentInput.value.trim()) {
                alert(translations[currentLang].commentRequired);
                return;
            }
            
            const newStatus = statusSelect.value;
            const newComment = {
                text: commentInput.value,
                status: newStatus,
                timestamp: new Date().toISOString(),
                operatorId: operatorInfo.operatorId || "SYSTEM",
                operatorName: operatorInfo.name || "System"
            };

            const docRef = doc(db, "applications", currentEditingDocId);
            
            saveBtn.disabled = true;
            saveBtn.textContent = translations[currentLang].savingBtn;

            try {
                await updateDoc(docRef, {
                    status: newStatus,
                    comments: arrayUnion(newComment)
                });
                closeEditModal();
            } catch (error) {
                console.error("Error updating document: ", error);
                alert(translations[currentLang].updateError);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = translations[currentLang].saveBtn;
            }
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                localStorage.removeItem('operatorInfo');
                window.location.href = './login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // Event Listeners
        sidebar.addEventListener('click', (e) => {
            e.preventDefault();
            const targetLink = e.target.closest('a');
            if (targetLink && targetLink.dataset.status) {
                sidebar.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                targetLink.classList.add('active');
                currentFilter = targetLink.dataset.status;
                mainTitle.textContent = targetLink.querySelector('span').textContent;
                renderFilteredApplications();
            }
        });

        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            renderFilteredApplications();
        });

        applicationsTbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                openEditModal(e.target.dataset.docId);
            }
        });
        cancelBtn.addEventListener('click', closeEditModal);
        saveBtn.addEventListener('click', saveStatus);

        document.querySelectorAll('.lang-switcher button').forEach(button => {
            button.addEventListener('click', (e) => setLanguage(e.target.dataset.lang));
        });

        document.getElementById('theme-switcher').addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        logoutBtn.addEventListener('click', handleLogout);

        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('theme-icon-sun').classList.add('hidden');
                document.getElementById('theme-icon-moon').classList.remove('hidden');
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('theme-icon-sun').classList.remove('hidden');
                document.getElementById('theme-icon-moon').classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        // Initial Load
        const savedLang = localStorage.getItem('language') || 'tj';
        const savedTheme = localStorage.getItem('theme') || 'dark';
        operatorInfo = JSON.parse(localStorage.getItem('operatorInfo')) || {};

        setLanguage(savedLang);
        setTheme(savedTheme);

    </script>
</body>
</html>
